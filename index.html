<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Physio Routine App</title>
  <style>
    /* Global Styles */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Arial, sans-serif;
      background: #f7faff;
      color: #333;
      padding: 1rem;
      max-width: 600px;
      margin: auto;
    }
    button { 
      padding: 0.6rem; 
      font-size: 1rem;
      background: #4a90e2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background: #3a7bc8; }
    select, input { 
      padding: 0.5rem; 
      font-size: 1rem; 
      margin-bottom: 0.5rem; 
      width: 100%; 
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    h1, h2 { margin-bottom: 1rem; color: #2c3e50; }
    .hidden { display: none; }
    .exercise-item { 
      padding: 0.8rem; 
      border-bottom: 1px solid #ddd; 
      display: flex; 
      justify-content: space-between;
      align-items: center;
      background: white;
      margin-bottom: 0.5rem;
      border-radius: 4px;
    }
    .controls { 
      display: flex; 
      justify-content: center;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .controls button { 
      padding: 0.8rem 1.2rem;
      font-size: 1.1rem;
    }
    .active { display: block; }
    .view { display: none; }
    .progress { 
      margin-top: 1rem; 
      text-align: center; 
      font-size: 1.2rem;
      background: white;
      padding: 1rem;
      border-radius: 4px;
    }
    svg { 
      width: 150px; 
      height: 150px; 
      margin: 1rem auto; 
      display: block; 
    }
    .offline { 
      color: green; 
      font-weight: bold;
      font-size: 0.9rem;
      margin-left: 1rem;
    }
    header {
      display: flex;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    #toggleView {
      margin-left: auto;
      background: #2c3e50;
    }
    #exerciseSvg {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
    .exercise-info {
      margin-right: 1rem;
    }
    @media (max-width: 480px) {
      body { padding: 0.5rem; }
      .controls { flex-wrap: wrap; }
      .controls button { flex: 1 1 30%; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Physio Routine</h1>
    <span id="offlineStatus" class="offline">Online</span>
    <button id="toggleView">Switch to Player</button>
  </header>

  <main>
    <!-- Routine Builder -->
    <section id="builderView" class="view active">
      <h2>Build Your Routine</h2>
      <select id="exerciseSelect">
        <option value="">Select an exercise</option>
      </select>
      <input type="number" id="reps" placeholder="Repetitions (e.g., 5)" min="1" value="5">
      <input type="number" id="duration" placeholder="Duration (seconds)" min="1" value="30">
      <input type="number" id="cycles" placeholder="Cycles (e.g., 2)" min="1" value="2">
      <button id="addExercise">Add to Routine</button>

      <div id="routineList" style="margin-top: 1.5rem;"></div>

      <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem;">
        <button id="saveRoutine" style="flex: 1;">Save Routine</button>
        <button id="startRoutine" style="flex: 1; background: #27ae60;">Start Routine</button>
      </div>
    </section>

    <!-- Exercise Player -->
    <section id="playerView" class="view">
      <h2 id="currentExerciseName">Ready to Start</h2>
      <div id="exerciseSvg"></div>
      <div class="progress">
        <p id="repCounter">Reps: 0</p>
        <p id="cycleCounter">Cycle: 0/0</p>
        <p id="timer">00s</p>
      </div>
      <div class="controls">
        <button id="prev">Previous</button>
        <button id="playPause">Pause</button>
        <button id="next">Next</button>
      </div>
      <button id="backToBuilder" style="width: 100%; margin-top: 1rem; background: #e74c3c;">Back to Builder</button>
    </section>
  </main>

<script>
  (function(){
    "use strict";

    // Exercise database
    const exercises = [
      {
        id: 1, 
        name: "Shoulder Stretch", 
        description: "Slowly raise arms to shoulder height and hold",
        svg: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" stroke="#3498db" stroke-width="3" fill="none"><animate attributeName="r" values="30;40;30" dur="2s" repeatCount="indefinite"/></circle><text x="50" y="20" text-anchor="middle" fill="#3498db" font-size="12">Shoulders</text></svg>`
      },
      {
        id: 2, 
        name: "Knee Flexion", 
        description: "Bend and straighten your knee slowly",
        svg: `<svg viewBox="0 0 100 100"><rect x="10" y="10" width="80" height="80" stroke="#e74c3c" stroke-width="3" fill="none"><animate attributeName="height" values="60;80;60" dur="2s" repeatCount="indefinite"/></rect><text x="50" y="20" text-anchor="middle" fill="#e74c3c" font-size="12">Knees</text></svg>`
      },
      {
        id: 3, 
        name: "Ankle Circles", 
        description: "Rotate ankles clockwise and counter-clockwise",
        svg: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="30" stroke="#2ecc71" stroke-width="3" fill="none"><animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="3s" repeatCount="indefinite"/></circle><text x="50" y="20" text-anchor="middle" fill="#2ecc71" font-size="12">Ankles</text></svg>`
      },
      {
        id: 4, 
        name: "Back Extension", 
        description: "Gently arch your back while supporting with hands",
        svg: `<svg viewBox="0 0 100 100"><line x1="10" y1="10" x2="90" y2="90" stroke="#9b59b6" stroke-width="3"><animate attributeName="x2" values="90;60;90" dur="2s" repeatCount="indefinite"/></line><text x="50" y="20" text-anchor="middle" fill="#9b59b6" font-size="12">Back</text></svg>`
      },
      {
        id: 5, 
        name: "Neck Tilts", 
        description: "Slowly tilt head side to side",
        svg: `<svg viewBox="0 0 100 100"><ellipse cx="50" cy="50" rx="30" ry="20" stroke="#f39c12" stroke-width="3" fill="none"><animate attributeName="rx" values="20;30;20" dur="2s" repeatCount="indefinite"/></ellipse><text x="50" y="20" text-anchor="middle" fill="#f39c12" font-size="12">Neck</text></svg>`
      },
    ];

    // App state
    let currentRoutine = [];
    let currentExerciseIndex = 0;
    let currentCycle = 1;
    let timer;
    let secondsLeft;
    let isPaused = false;
    let speechSynthesis = window.speechSynthesis;

    // DOM elements
    const els = {
      toggleView: document.getElementById('toggleView'),
      builderView: document.getElementById('builderView'),
      playerView: document.getElementById('playerView'),
      exerciseSelect: document.getElementById('exerciseSelect'),
      reps: document.getElementById('reps'),
      duration: document.getElementById('duration'),
      cycles: document.getElementById('cycles'),
      addExercise: document.getElementById('addExercise'),
      routineList: document.getElementById('routineList'),
      saveRoutine: document.getElementById('saveRoutine'),
      startRoutine: document.getElementById('startRoutine'),
      currentExerciseName: document.getElementById('currentExerciseName'),
      exerciseSvg: document.getElementById('exerciseSvg'),
      repCounter: document.getElementById('repCounter'),
      cycleCounter: document.getElementById('cycleCounter'),
      timer: document.getElementById('timer'),
      prev: document.getElementById('prev'),
      next: document.getElementById('next'),
      playPause: document.getElementById('playPause'),
      backToBuilder: document.getElementById('backToBuilder'),
      offlineStatus: document.getElementById('offlineStatus')
    };

    // Initialize the app
    function init() {
      // Populate exercise dropdown
      exercises.forEach(ex => {
        const option = document.createElement('option');
        option.value = ex.id;
        option.textContent = ex.name;
        els.exerciseSelect.appendChild(option);
      });

      // Load saved routine if exists
      const savedRoutine = localStorage.getItem('physioRoutine');
      if (savedRoutine) {
        try {
          currentRoutine = JSON.parse(savedRoutine);
          renderRoutine();
        } catch (e) {
          console.error("Error loading saved routine:", e);
        }
      }

      // Set up event listeners
      els.addExercise.addEventListener('click', addExerciseToRoutine);
      els.saveRoutine.addEventListener('click', saveRoutine);
      els.startRoutine.addEventListener('click', startRoutine);
      els.toggleView.addEventListener('click', toggleView);
      els.playPause.addEventListener('click', togglePause);
      els.next.addEventListener('click', () => nextExercise(1));
      els.prev.addEventListener('click', () => nextExercise(-1));
      els.backToBuilder.addEventListener('click', () => {
        stopExercise();
        toggleView();
      });

      // Check online status
      updateOnlineStatus();
      window.addEventListener('online', updateOnlineStatus);
      window.addEventListener('offline', updateOnlineStatus);

      // Simple service worker registration (commented out as GitHub Pages requires actual file)
      // if ('serviceWorker' in navigator) {
      //   navigator.serviceWorker.register('/sw.js').catch(err => {
      //     console.log('ServiceWorker registration failed: ', err);
      //   });
      // }
    }

    function updateOnlineStatus() {
      const isOnline = navigator.onLine;
      els.offlineStatus.textContent = isOnline ? "Online" : "Offline";
      els.offlineStatus.style.color = isOnline ? "green" : "red";
    }

    function addExerciseToRoutine() {
      const exerciseId = els.exerciseSelect.value;
      if (!exerciseId) {
        alert("Please select an exercise");
        return;
      }

      const reps = parseInt(els.reps.value) || 5;
      const duration = parseInt(els.duration.value) || 30;
      const cycles = parseInt(els.cycles.value) || 2;

      const exercise = exercises.find(e => e.id == exerciseId);
      if (!exercise) return;

      currentRoutine.push({
        ...exercise,
        reps: reps,
        duration: duration,
        cycles: cycles,
        currentRep: 1,
        currentCycle: 1
      });

      renderRoutine();
    }

    function renderRoutine() {
      els.routineList.innerHTML = '';
      
      if (currentRoutine.length === 0) {
        els.routineList.innerHTML = '<p style="text-align: center; color: #777;">No exercises added yet</p>';
        return;
      }

      currentRoutine.forEach((ex, i) => {
        const div = document.createElement('div');
        div.className = 'exercise-item';
        div.innerHTML = `
          <div class="exercise-info">
            <strong>${ex.name}</strong><br>
            ${ex.reps} reps, ${ex.duration}s, ${ex.cycles} cycles
          </div>
          <button class="remove-btn" data-index="${i}">Remove</button>
        `;
        els.routineList.appendChild(div);
      });

      // Add event listeners to remove buttons
      document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const index = parseInt(this.getAttribute('data-index'));
          currentRoutine.splice(index, 1);
          renderRoutine();
        });
      });
    }

    function saveRoutine() {
      if (currentRoutine.length === 0) {
        alert("Your routine is empty. Add some exercises first.");
        return;
      }
      localStorage.setItem('physioRoutine', JSON.stringify(currentRoutine));
      alert("Routine saved successfully!");
    }

    function startRoutine() {
      if (currentRoutine.length === 0) {
        alert("Your routine is empty. Add some exercises first.");
        return;
      }
      toggleView();
      currentExerciseIndex = 0;
      currentCycle = 1;
      playExercise();
    }

    function playExercise() {
      if (currentExerciseIndex >= currentRoutine.length) {
        endRoutine();
        return;
      }

      const ex = currentRoutine[currentExerciseIndex];
      els.currentExerciseName.textContent = ex.name;
      els.exerciseSvg.innerHTML = ex.svg;
      secondsLeft = ex.duration;
      els.repCounter.textContent = `Reps: 1/${ex.reps}`;
      els.cycleCounter.textContent = `Cycle: ${currentCycle}/${ex.cycles}`;
      els.timer.textContent = `${secondsLeft}s`;
      els.playPause.textContent = "Pause";

      // Speak the exercise name
      if (speechSynthesis) {
        const utterance = new SpeechSynthesisUtterance(`Now performing ${ex.name}. ${ex.reps} repetitions.`);
        speechSynthesis.speak(utterance);
      }

      clearInterval(timer);
      timer = setInterval(updateTimer, 1000);
    }

    function updateTimer() {
      if (isPaused) return;

      secondsLeft--;
      els.timer.textContent = `${secondsLeft}s`;

      if (secondsLeft <= 0) {
        const ex = currentRoutine[currentExerciseIndex];
        ex.currentRep++;

        if (ex.currentRep > ex.reps) {
          ex.currentRep = 1;
          currentCycle++;
          
          if (currentCycle > ex.cycles) {
            currentCycle = 1;
            nextExercise(1);
            return;
          }
        }

        els.repCounter.textContent = `Reps: ${ex.currentRep}/${ex.reps}`;
        els.cycleCounter.textContent = `Cycle: ${currentCycle}/${ex.cycles}`;
        secondsLeft = ex.duration;
        
        // Speak the rep count
        if (speechSynthesis) {
          const utterance = new SpeechSynthesisUtterance(`Repetition ${ex.currentRep}`);
          speechSynthesis.speak(utterance);
        }
      }
    }

    function nextExercise(dir) {
      clearInterval(timer);
      currentExerciseIndex += dir;
      currentCycle = 1;
      
      if (currentExerciseIndex < 0) {
        currentExerciseIndex = 0;
      } else if (currentExerciseIndex >= currentRoutine.length) {
        endRoutine();
        return;
      }
      
      playExercise();
    }

    function togglePause() {
      isPaused = !isPaused;
      els.playPause.textContent = isPaused ? "Resume" : "Pause";
    }

    function stopExercise() {
      clearInterval(timer);
      isPaused = false;
      els.playPause.textContent = "Pause";
    }

    function endRoutine() {
      stopExercise();
      els.currentExerciseName.textContent = "Routine Complete!";
      els.exerciseSvg.innerHTML = `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="#2ecc71"/><path fill="none" stroke="#fff" stroke-width="8" stroke-linecap="round" d="M30,50 l15,15 l30,-30"/></svg>`;
      els.repCounter.textContent = "";
      els.cycleCounter.textContent = "";
      els.timer.textContent = "Well done!";
      
      if (speechSynthesis) {
        const utterance = new SpeechSynthesisUtterance("Routine complete. Great job!");
        speechSynthesis.speak(utterance);
      }
    }

    function toggleView() {
      els.builderView.classList.toggle('active');
      els.playerView.classList.toggle('active');
      els.toggleView.textContent = els.builderView.classList.contains('active') 
        ? "Switch to Player" 
        : "Switch to Builder";
    }

    // Start the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', init);
  })();
</script>
</body>
</html>
